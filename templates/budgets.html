{% extends "base.html" %}
{% block title %}Budgets - Receipt Tracker{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12 d-flex justify-content-between align-items-center">
        <div><h2 class="mb-0">Budget Management</h2><p class="text-muted mb-0">Set spending limits by category</p></div>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#budgetModal"><i class="bi bi-plus-lg me-2"></i>Add Budget</button>
    </div>
</div>

<div class="row">
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header"><i class="bi bi-piggy-bank me-2"></i>Current Budgets</div>
            <div class="card-body" id="budgetsList"></div>
        </div>
    </div>
    <div class="col-lg-4 mb-4">
        <div class="card">
            <div class="card-header"><i class="bi bi-bar-chart me-2"></i>Budget Overview</div>
            <div class="card-body">
                <div class="chart-container" style="height:250px;"><canvas id="budgetChart"></canvas></div>
                <hr>
                <div class="row text-center">
                    <div class="col-6">
                        <h5 class="text-success mb-0" id="underBudget">0</h5>
                        <small class="text-muted">Under Budget</small>
                    </div>
                    <div class="col-6">
                        <h5 class="text-danger mb-0" id="overBudget">0</h5>
                        <small class="text-muted">Over/Near Limit</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Budget Modal -->
<div class="modal fade" id="budgetModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="budgetModalTitle">Add Budget</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="budgetForm">
                    <input type="hidden" id="budgetId">
                    <div class="mb-3">
                        <label class="form-label">Category <span class="text-danger">*</span></label>
                        <select class="form-select" id="budgetCategory" required>
                            {% for cat in categories %}<option value="{{ cat }}">{{ cat }}</option>{% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Monthly Limit <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="budgetAmount" required step="0.01" min="0" placeholder="0.00">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Period</label>
                        <select class="form-select" id="budgetPeriod">
                            <option value="monthly" selected>Monthly</option>
                            <option value="weekly">Weekly</option>
                            <option value="yearly">Yearly</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveBudgetBtn">Save Budget</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let budgetChart, budgetModal;
const categories = {{ categories | tojson }};

async function loadBudgets() {
    const [budgets, dashData] = await Promise.all([
        fetch('/api/budgets').then(r => r.json()),
        fetch('/api/dashboard-data').then(r => r.json())
    ]);
    
    const container = document.getElementById('budgetsList');
    const budgetStatus = dashData.budget_status || [];
    
    if (!budgets.length) {
        container.innerHTML = '<p class="text-muted text-center py-4">No budgets set yet. Click "Add Budget" to create one.</p>';
        return;
    }
    
    let underCount = 0, overCount = 0;
    
    container.innerHTML = budgets.map(b => {
        const status = budgetStatus.find(s => s.category === b.category) || { spent: 0, percentage: 0 };
        const pct = status.percentage;
        let color = 'success', icon = 'check-circle';
        
        if (pct >= 100) { color = 'danger'; icon = 'exclamation-circle'; overCount++; }
        else if (pct >= 75) { color = 'warning'; icon = 'exclamation-triangle'; overCount++; }
        else { underCount++; }
        
        return `
        <div class="border rounded p-3 mb-3">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                    <h5 class="mb-1"><i class="bi bi-${icon} text-${color} me-2"></i>${b.category}</h5>
                    <small class="text-muted">${b.period.charAt(0).toUpperCase() + b.period.slice(1)} budget</small>
                </div>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="editBudget(${b.id}, '${b.category}', ${b.amount}, '${b.period}')"><i class="bi bi-pencil"></i></button>
                    <button class="btn btn-outline-danger" onclick="deleteBudget(${b.id})"><i class="bi bi-trash"></i></button>
                </div>
            </div>
            <div class="d-flex justify-content-between mb-1">
                <span>Spent: ${formatCurrency(status.spent)}</span>
                <span>Limit: ${formatCurrency(b.amount)}</span>
            </div>
            <div class="progress budget-progress mb-2">
                <div class="progress-bar bg-${color}" style="width:${Math.min(pct, 100)}%"></div>
            </div>
            <div class="d-flex justify-content-between">
                <small class="text-${color}">${pct.toFixed(0)}% used</small>
                <small class="text-muted">Remaining: ${formatCurrency(parseFloat(b.amount) - status.spent)}</small>
            </div>
        </div>`;
    }).join('');
    
    document.getElementById('underBudget').textContent = underCount;
    document.getElementById('overBudget').textContent = overCount;
    
    updateBudgetChart(budgetStatus);
}

function updateBudgetChart(budgetStatus) {
    const ctx = document.getElementById('budgetChart').getContext('2d');
    if (budgetChart) budgetChart.destroy();
    
    if (!budgetStatus.length) return;
    
    budgetChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: budgetStatus.map(b => b.category),
            datasets: [
                { label: 'Spent', data: budgetStatus.map(b => b.spent), backgroundColor: '#f72585', borderRadius: 4 },
                { label: 'Limit', data: budgetStatus.map(b => b.limit), backgroundColor: '#dee2e6', borderRadius: 4 }
            ]
        },
        options: {
            indexAxis: 'y', responsive: true, maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom' } },
            scales: { x: { beginAtZero: true, ticks: { callback: v => '$' + v } } }
        }
    });
}

function editBudget(id, category, amount, period) {
    document.getElementById('budgetModalTitle').textContent = 'Edit Budget';
    document.getElementById('budgetId').value = id;
    document.getElementById('budgetCategory').value = category;
    document.getElementById('budgetAmount').value = amount;
    document.getElementById('budgetPeriod').value = period;
    budgetModal.show();
}

async function deleteBudget(id) {
    if (!confirm('Delete this budget?')) return;
    await fetch(`/api/budgets/${id}`, { method: 'DELETE' });
    loadBudgets();
}

document.getElementById('saveBudgetBtn').addEventListener('click', async () => {
    const id = document.getElementById('budgetId').value;
    const data = {
        category: document.getElementById('budgetCategory').value,
        amount: parseFloat(document.getElementById('budgetAmount').value),
        period: document.getElementById('budgetPeriod').value
    };
    
    if (id) {
        await fetch(`/api/budgets/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
    } else {
        await fetch('/api/budgets', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
    }
    
    budgetModal.hide();
    document.getElementById('budgetForm').reset();
    document.getElementById('budgetId').value = '';
    loadBudgets();
});

document.getElementById('budgetModal').addEventListener('hidden.bs.modal', () => {
    document.getElementById('budgetForm').reset();
    document.getElementById('budgetId').value = '';
    document.getElementById('budgetModalTitle').textContent = 'Add Budget';
});

budgetModal = new bootstrap.Modal(document.getElementById('budgetModal'));
loadBudgets();
</script>
{% endblock %}
