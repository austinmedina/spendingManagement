{% extends "base.html" %}
{% block title %}Search Transactions - Receipt Tracker{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12"><h2 class="mb-0">Search Transactions</h2><p class="text-muted">Find and filter your transaction history</p></div>
</div>

<div class="card mb-4">
    <div class="card-header"><i class="bi bi-funnel me-2"></i>Filters</div>
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-4">
                <label class="form-label small text-muted">Search</label>
                <input type="text" class="form-control" id="searchQuery" placeholder="Item name or store...">
            </div>
            <div class="col-md-2">
                <label class="form-label small text-muted">Category</label>
                <select class="form-select" id="filterCategory">
                    <option value="">All Categories</option>
                    {% for cat in categories %}<option value="{{ cat }}">{{ cat }}</option>{% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label small text-muted">Account</label>
                <select class="form-select" id="filterAccount"><option value="">All Accounts</option></select>
            </div>
            <div class="col-md-2">
                <label class="form-label small text-muted">Type</label>
                <select class="form-select" id="filterType">
                    <option value="">All Types</option>
                    <option value="expense">Expenses</option>
                    <option value="income">Income</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label small text-muted">Person</label>
                <select class="form-select" id="filterPerson"><option value="">All Persons</option></select>
            </div>
            <div class="col-md-3">
                <label class="form-label small text-muted">Start Date</label>
                <input type="date" class="form-control" id="startDate">
            </div>
            <div class="col-md-3">
                <label class="form-label small text-muted">End Date</label>
                <input type="date" class="form-control" id="endDate">
            </div>
            <div class="col-md-6 d-flex align-items-end">
                <button class="btn btn-primary me-2" id="searchBtn"><i class="bi bi-search me-2"></i>Search</button>
                <button class="btn btn-outline-secondary" id="clearBtn"><i class="bi bi-x-lg me-2"></i>Clear</button>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-table me-2"></i>Results</span>
        <span class="badge bg-primary" id="resultCount">0 transactions</span>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="bg-light"><tr><th>Date</th><th>Item</th><th>Category</th><th>Store</th><th>Person</th><th>Account</th><th>Receipt</th><th class="text-end">Amount</th></tr></thead>
                <tbody id="resultsTable"></tbody>
            </table>
        </div>
    </div>
    <div class="card-footer bg-white">
        <div class="d-flex justify-content-between align-items-center">
            <span class="text-muted" id="summaryText">Total: $0.00</span>
            <button class="btn btn-sm btn-outline-primary" id="exportBtn"><i class="bi bi-download me-2"></i>Export CSV</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let allTransactions = [];

async function loadFilters() {
    const [accounts, persons] = await Promise.all([fetch('/api/accounts').then(r=>r.json()), fetch('/api/persons').then(r=>r.json())]);
    const accSel = document.getElementById('filterAccount');
    const perSel = document.getElementById('filterPerson');
    accounts.forEach(a => accSel.innerHTML += `<option value="${a}">${a}</option>`);
    persons.forEach(p => perSel.innerHTML += `<option value="${p}">${p}</option>`);
}

async function searchTransactions() {
    const params = new URLSearchParams();
    const q = document.getElementById('searchQuery').value;
    const cat = document.getElementById('filterCategory').value;
    const acc = document.getElementById('filterAccount').value;
    const type = document.getElementById('filterType').value;
    const person = document.getElementById('filterPerson').value;
    const start = document.getElementById('startDate').value;
    const end = document.getElementById('endDate').value;
    
    if (q) params.append('q', q);
    if (cat) params.append('category', cat);
    if (acc) params.append('bank_account', acc);
    if (type) params.append('type', type);
    if (person) params.append('person', person);
    if (start) params.append('start_date', start);
    if (end) params.append('end_date', end);
    
    allTransactions = await fetch('/api/transactions?' + params).then(r => r.json());
    displayResults(allTransactions);
}

function displayResults(data) {
    document.getElementById('storeName').value = data.store || '';
    document.getElementById('receiptDate').value = data.date || new Date().toISOString().split('T')[0];
    
    const itemsList = document.getElementById('itemsList');
    itemsList.innerHTML = data.items.map((item, i) => `
        <div class="border rounded p-3 mb-3" data-index="${i}">
            <div class="d-flex align-items-start mb-2">
                <input type="checkbox" class="form-check-input me-2 item-check mt-2" checked>
                <div class="flex-grow-1">
                    <input type="text" class="form-control form-control-sm mb-2 item-name" value="${item.name}">
                    <div class="row">
                        <div class="col-6">
                            <select class="form-select form-select-sm item-category">
                                ${categories.map(c => `<option ${c === item.category ? 'selected' : ''}>${c}</option>`).join('')}
                            </select>
                        </div>
                        <div class="col-6">
                            <div class="input-group input-group-sm">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control item-price" value="${item.price.toFixed(2)}" step="0.01">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Per-item split toggle -->
            <div class="item-split-section mt-2" style="display:none;">
                <small class="text-muted d-block mb-2">Split this item:</small>
                <div class="item-split-container"></div>
            </div>
            <button type="button" class="btn btn-sm btn-outline-secondary item-split-toggle" onclick="toggleItemSplit(${i})">
                <i class="bi bi-people"></i> Custom Split
            </button>
        </div>
    `).join('');
    
    updateTotal();
    document.getElementById('resultsCard').style.display = 'block';
    
    itemsList.querySelectorAll('.item-check, .item-price').forEach(el => {
        el.addEventListener('change', updateTotal);
    });
}

function toggleItemSplit(index) {
    const itemDiv = document.querySelector(`[data-index="${index}"]`);
    const splitSection = itemDiv.querySelector('.item-split-section');
    const groupId = document.getElementById('groupSelect').value;
    
    if (!groupId) {
        alert('Please select a group first');
        return;
    }
    
    const group = groups.find(g => g.id === groupId);
    if (!group) return;
    
    if (splitSection.style.display === 'none') {
        const members = group.members.split(',');
        const equalSplit = (100 / members.length).toFixed(2);
        
        splitSection.querySelector('.item-split-container').innerHTML = members.map(m => `
            <div class="d-flex align-items-center mb-1">
                <input type="checkbox" class="form-check-input me-2 item-split-member-check" data-person="${m}" checked>
                <span class="me-2" style="width:80px;">${m}</span>
                <input type="number" class="form-control form-control-sm item-split-percent" data-person="${m}" value="${equalSplit}" min="0" max="100" step="0.01" style="width:70px;">
                <span class="ms-1">%</span>
            </div>
        `).join('');
        
        // Handle member deselection
        splitSection.querySelectorAll('.item-split-member-check').forEach(cb => {
            cb.addEventListener('change', function() {
                const person = this.dataset.person;
                const percentInput = splitSection.querySelector(`input.item-split-percent[data-person="${person}"]`);
                if (this.checked) {
                    percentInput.disabled = false;
                } else {
                    percentInput.disabled = true;
                    percentInput.value = 0;
                }
                redistributeItemSplit(splitSection);
            });
        });
        
        splitSection.style.display = 'block';
        itemDiv.querySelector('.item-split-toggle').innerHTML = '<i class="bi bi-x"></i> Cancel Split';
    } else {
        splitSection.style.display = 'none';
        itemDiv.querySelector('.item-split-toggle').innerHTML = '<i class="bi bi-people"></i> Custom Split';
    }
}

function redistributeItemSplit(splitSection) {
    const checkedInputs = splitSection.querySelectorAll('.item-split-member-check:checked');
    if (checkedInputs.length === 0) return;
    
    const equalSplit = (100 / checkedInputs.length).toFixed(2);
    checkedInputs.forEach(cb => {
        const person = cb.dataset.person;
        const percentInput = splitSection.querySelector(`input.item-split-percent[data-person="${person}"]`);
        percentInput.value = equalSplit;
    });
}

// Update the save button to handle per-item splits
document.getElementById('saveBtn').addEventListener('click', async () => {
    const items = [];
    const itemDivs = document.querySelectorAll('#itemsList > div');
    const groupId = document.getElementById('groupSelect').value;
    
    // Collect items with their individual splits
    itemDivs.forEach(div => {
        if (!div.querySelector('.item-check').checked) return;
        
        const item = {
            name: div.querySelector('.item-name').value,
            category: div.querySelector('.item-category').value,
            price: parseFloat(div.querySelector('.item-price').value) || 0
        };
        
        // Check if this item has custom splits
        const splitSection = div.querySelector('.item-split-section');
        if (splitSection.style.display !== 'none' && groupId) {
            const splits = [];
            const checkedMembers = splitSection.querySelectorAll('.item-split-member-check:checked');
            
            checkedMembers.forEach(cb => {
                const person = cb.dataset.person;
                const percent = parseFloat(splitSection.querySelector(`input.item-split-percent[data-person="${person}"]`).value) || 0;
                splits.push({
                    person: person,
                    percentage: percent,
                    amount: (item.price * percent / 100).toFixed(2)
                });
            });
            
            item.splits = splits;
        }
        
        items.push(item);
    });
    
    if (!items.length) { alert('Select at least one item'); return; }
    
    // Calculate receipt-level splits (for items without custom splits)
    const receiptSplits = [];
    if (groupId) {
        const group = groups.find(g => g.id === groupId);
        if (group) {
            const members = group.members.split(',');
            const totalPrice = items.filter(i => !i.splits).reduce((sum, i) => sum + i.price, 0);
            const equalSplit = (100 / members.length).toFixed(2);
            
            members.forEach(m => {
                receiptSplits.push({
                    person: m,
                    percentage: equalSplit,
                    amount: (totalPrice * equalSplit / 100).toFixed(2)
                });
            });
        }
    }
    
    try {
        const res = await fetch('/api/save-items', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                items, 
                store: document.getElementById('storeName').value, 
                date: document.getElementById('receiptDate').value, 
                bank_account: document.getElementById('bankAccount').value, 
                receipt_image: receiptImage,
                group_id: groupId,
                splits: receiptSplits
            })
        });
        
        const data = await res.json();
        if (data.success) {
            document.getElementById('successMessage').textContent = `Saved ${data.saved} items!`;
            document.getElementById('successAlert').classList.remove('d-none');
            document.getElementById('resultsCard').style.display = 'none';
            // Reset form...
        }
    } catch (e) { alert('Error: ' + e.message); }
});

document.getElementById('searchBtn').addEventListener('click', searchTransactions);
document.getElementById('clearBtn').addEventListener('click', () => {
    document.querySelectorAll('#searchQuery,#filterCategory,#filterAccount,#filterType,#filterPerson,#startDate,#endDate').forEach(el => el.value = '');
    searchTransactions();
});
document.getElementById('searchQuery').addEventListener('keypress', e => { if (e.key==='Enter') searchTransactions(); });

document.getElementById('exportBtn').addEventListener('click', () => {
    if (!allTransactions.length) { alert('No data'); return; }
    const headers = ['Date','Item','Category','Store','Person','Account','Type','Amount','Receipt'];
    const rows = allTransactions.map(t => [t.date,`"${t.item_name}"`,t.category,`"${t.store}"`,t.person,t.bank_account,t.type,t.price,t.receipt_image||''].join(','));
    const blob = new Blob([[headers.join(','), ...rows].join('\n')], { type: 'text/csv' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'csv/transactions.csv'; a.click();
});

loadFilters();
searchTransactions();
</script>
{% endblock %}
