{% extends "base.html" %}
{% block title %}Search Transactions - Receipt Tracker{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12"><h2 class="mb-0">Search Transactions</h2><p class="text-muted">Find and filter your transaction history</p></div>
</div>

<div class="card mb-4">
    <div class="card-header"><i class="bi bi-funnel me-2"></i>Filters</div>
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-4">
                <label class="form-label small text-muted">Search</label>
                <input type="text" class="form-control" id="searchQuery" placeholder="Item name or store...">
            </div>
            <div class="col-md-2">
                <label class="form-label small text-muted">Category</label>
                <select class="form-select" id="filterCategory">
                    <option value="">All Categories</option>
                    {% for cat in categories %}<option value="{{ cat }}">{{ cat }}</option>{% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label small text-muted">Account</label>
                <select class="form-select" id="filterAccount"><option value="">All Accounts</option></select>
            </div>
            <div class="col-md-2">
                <label class="form-label small text-muted">Type</label>
                <select class="form-select" id="filterType">
                    <option value="">All Types</option>
                    <option value="expense">Expenses</option>
                    <option value="income">Income</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label small text-muted">Person</label>
                <select class="form-select" id="filterPerson"><option value="">All Persons</option></select>
            </div>
            <div class="col-md-3">
                <label class="form-label small text-muted">Start Date</label>
                <input type="date" class="form-control" id="startDate">
            </div>
            <div class="col-md-3">
                <label class="form-label small text-muted">End Date</label>
                <input type="date" class="form-control" id="endDate">
            </div>
            <div class="col-md-6 d-flex align-items-end">
                <button class="btn btn-primary me-2" id="searchBtn"><i class="bi bi-search me-2"></i>Search</button>
                <button class="btn btn-outline-secondary" id="clearBtn"><i class="bi bi-x-lg me-2"></i>Clear</button>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-table me-2"></i>Results</span>
        <span class="badge bg-primary" id="resultCount">0 transactions</span>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="bg-light"><tr><th>Date</th><th>Item</th><th>Category</th><th>Store</th><th>Person</th><th>Account</th><th>Receipt</th><th class="text-end">Amount</th></tr></thead>
                <tbody id="resultsTable"></tbody>
            </table>
        </div>
    </div>
    <div class="card-footer bg-white">
        <div class="d-flex justify-content-between align-items-center">
            <span class="text-muted" id="summaryText">Total: $0.00</span>
            <button class="btn btn-sm btn-outline-primary" id="exportBtn"><i class="bi bi-download me-2"></i>Export CSV</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let allTransactions = [];

async function loadFilters() {
    const [accounts, persons] = await Promise.all([fetch('/api/accounts').then(r=>r.json()), fetch('/api/persons').then(r=>r.json())]);
    const accSel = document.getElementById('filterAccount');
    const perSel = document.getElementById('filterPerson');
    accounts.forEach(a => accSel.innerHTML += `<option value="${a}">${a}</option>`);
    persons.forEach(p => perSel.innerHTML += `<option value="${p}">${p}</option>`);
}

async function searchTransactions() {
    const params = new URLSearchParams();
    const q = document.getElementById('searchQuery').value;
    const cat = document.getElementById('filterCategory').value;
    const acc = document.getElementById('filterAccount').value;
    const type = document.getElementById('filterType').value;
    const person = document.getElementById('filterPerson').value;
    const start = document.getElementById('startDate').value;
    const end = document.getElementById('endDate').value;
    
    if (q) params.append('q', q);
    if (cat) params.append('category', cat);
    if (acc) params.append('bank_account', acc);
    if (type) params.append('type', type);
    if (person) params.append('person', person);
    if (start) params.append('start_date', start);
    if (end) params.append('end_date', end);
    
    allTransactions = await fetch('/api/transactions?' + params).then(r => r.json());
    displayResults(allTransactions);
}

function displayResults(transactions) {
    const tbody = document.getElementById('resultsTable');
    const sorted = transactions.sort((a,b) => b.date.localeCompare(a.date));
    
    if (!sorted.length) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4">No transactions found</td></tr>';
        document.getElementById('resultCount').textContent = '0 transactions';
        document.getElementById('summaryText').textContent = 'Total: $0.00';
        return;
    }
    
    tbody.innerHTML = sorted.map(t => `
        <tr>
            <td>${t.date}</td>
            <td><strong>${t.item_name}</strong></td>
            <td><span class="badge bg-secondary badge-category">${t.category}</span></td>
            <td>${t.store}</td>
            <td>${t.person}</td>
            <td>${t.bank_account}</td>
            <td>${t.receipt_image ? `<img src="/receipts/${t.receipt_image}" class="receipt-thumb" onclick="showReceipt('${t.receipt_image}')">` : '<span class="text-muted">-</span>'}</td>
            <td class="text-end ${t.type==='income'?'text-success':'text-danger'}">${t.type==='income'?'+':'-'}${formatCurrency(t.price)}</td>
        </tr>
    `).join('');
    
    document.getElementById('resultCount').textContent = `${sorted.length} transaction${sorted.length!==1?'s':''}`;
    const income = sorted.filter(t => t.type==='income').reduce((s,t) => s + parseFloat(t.price), 0);
    const expenses = sorted.filter(t => t.type!=='income').reduce((s,t) => s + parseFloat(t.price), 0);
    document.getElementById('summaryText').textContent = `Income: ${formatCurrency(income)} | Expenses: ${formatCurrency(expenses)} | Net: ${formatCurrency(income-expenses)}`;
}

document.getElementById('searchBtn').addEventListener('click', searchTransactions);
document.getElementById('clearBtn').addEventListener('click', () => {
    document.querySelectorAll('#searchQuery,#filterCategory,#filterAccount,#filterType,#filterPerson,#startDate,#endDate').forEach(el => el.value = '');
    searchTransactions();
});
document.getElementById('searchQuery').addEventListener('keypress', e => { if (e.key==='Enter') searchTransactions(); });

document.getElementById('exportBtn').addEventListener('click', () => {
    if (!allTransactions.length) { alert('No data'); return; }
    const headers = ['Date','Item','Category','Store','Person','Account','Type','Amount','Receipt'];
    const rows = allTransactions.map(t => [t.date,`"${t.item_name}"`,t.category,`"${t.store}"`,t.person,t.bank_account,t.type,t.price,t.receipt_image||''].join(','));
    const blob = new Blob([[headers.join(','), ...rows].join('\n')], { type: 'text/csv' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'transactions.csv'; a.click();
});

loadFilters();
searchTransactions();
</script>
{% endblock %}
