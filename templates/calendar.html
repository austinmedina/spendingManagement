{% extends "base.html" %}
{% block title %}Calendar - Receipt Tracker{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12 d-flex justify-content-between align-items-center">
        <div><h2 class="mb-0">Group Calendar</h2><p class="text-muted mb-0">Shared events with your groups</p></div>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#eventModal">
            <i class="bi bi-plus-lg me-2"></i>Add Event
        </button>
    </div>
</div>

<div class="row">
    <div class="col-lg-9 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between">
                <span><i class="bi bi-calendar3 me-2"></i>Calendar</span>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-secondary" id="prevMonth"><i class="bi bi-chevron-left"></i></button>
                    <button class="btn btn-outline-secondary" id="currentMonthLabel" style="min-width:150px;"></button>
                    <button class="btn btn-outline-secondary" id="nextMonth"><i class="bi bi-chevron-right"></i></button>
                </div>
            </div>
            <div class="card-body p-0">
                <div id="calendar" class="p-3"></div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 mb-4">
        <div class="card">
            <div class="card-header"><i class="bi bi-list-check me-2"></i>Upcoming Events</div>
            <div class="card-body" id="upcomingEvents" style="max-height:500px;overflow-y:auto;"></div>
        </div>
    </div>
</div>

<!-- Add Event Modal -->
<div class="modal fade" id="eventModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Calendar Event</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="eventForm">
                    <div class="mb-3">
                        <label class="form-label">Group <span class="text-danger">*</span></label>
                        <select class="form-select" id="eventGroup" required>
                            <option value="">Select group</option>
                            {% for group in groups %}
                            <option value="{{ group.id }}">{{ group.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Title <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="eventTitle" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="eventDescription" rows="3"></textarea>
                    </div>
                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="form-label">Date <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="eventDate" required>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Time</label>
                            <input type="time" class="form-control" id="eventTime">
                        </div>
                    </div>
                    <div class="form-check mb-3">
                        <input type="checkbox" class="form-check-input" id="eventAllDay">
                        <label class="form-check-label" for="eventAllDay">All day event</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveEventBtn">Save Event</button>
            </div>
        </div>
    </div>
</div>

<style>
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
    .calendar-day { aspect-ratio: 1; border: 1px solid #dee2e6; padding: 5px; border-radius: 4px; cursor: pointer; position: relative; }
    .calendar-day:hover { background: #f8f9fa; }
    .calendar-day.other-month { opacity: 0.3; }
    .calendar-day.today { background: #e7f1ff; border-color: #4361ee; font-weight: bold; }
    .calendar-day.has-events { background: #fff3cd; }
    .calendar-header { font-weight: 600; text-align: center; padding: 10px; background: #f8f9fa; }
    .event-dot { width: 6px; height: 6px; border-radius: 50%; background: #4361ee; position: absolute; bottom: 5px; left: 50%; transform: translateX(-50%); }
</style>
{% endblock %}

{% block extra_js %}
<script>
let currentMonth = new Date();
let allEvents = [];
let eventModal;

async function loadEvents() {
    allEvents = await fetch('/api/calendar/events').then(r => r.json());
    renderCalendar();
    renderUpcoming();
}

function renderCalendar() {
    const year = currentMonth.getFullYear();
    const month = currentMonth.getMonth();
    
    document.getElementById('currentMonthLabel').textContent = new Date(year, month).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
    
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const daysInPrevMonth = new Date(year, month, 0).getDate();
    
    let html = '<div class="calendar-grid">';
    ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
        html += `<div class="calendar-header">${day}</div>`;
    });
    
    // Previous month days
    for (let i = firstDay - 1; i >= 0; i--) {
        html += `<div class="calendar-day other-month">${daysInPrevMonth - i}</div>`;
    }
    
    // Current month days
    const today = new Date();
    for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const isToday = today.getDate() === day && today.getMonth() === month && today.getFullYear() === year;
        const hasEvents = allEvents.some(e => e.event_date === dateStr);
        
        html += `<div class="calendar-day ${isToday ? 'today' : ''} ${hasEvents ? 'has-events' : ''}" onclick="showDayEvents('${dateStr}')">
            ${day}
            ${hasEvents ? '<div class="event-dot"></div>' : ''}
        </div>`;
    }
    
    html += '</div>';
    document.getElementById('calendar').innerHTML = html;
}

function showDayEvents(dateStr) {
    const dayEvents = allEvents.filter(e => e.event_date === dateStr);
    if (!dayEvents.length) return;
    
    const content = dayEvents.map(e => `
        <div class="border-bottom py-2">
            <strong>${e.title}</strong><br>
            <small>${e.event_time || 'All day'}</small><br>
            ${e.description ? `<small class="text-muted">${e.description}</small>` : ''}
        </div>
    `).join('');
    
    alert(`Events on ${dateStr}:\n\n${dayEvents.map(e => `${e.title} - ${e.event_time || 'All day'}`).join('\n')}`);
}

function renderUpcoming() {
    const today = new Date().toISOString().split('T')[0];
    const upcoming = allEvents.filter(e => e.event_date >= today).sort((a, b) => a.event_date.localeCompare(b.event_date)).slice(0, 10);
    
    const container = document.getElementById('upcomingEvents');
    if (!upcoming.length) {
        container.innerHTML = '<p class="text-muted text-center">No upcoming events</p>';
        return;
    }
    
    container.innerHTML = upcoming.map(e => `
        <div class="mb-3 pb-3 border-bottom">
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <strong>${e.title}</strong>
                    <div class="small text-muted">${e.event_date} ${e.event_time || ''}</div>
                    ${e.description ? `<div class="small">${e.description}</div>` : ''}
                    <small class="badge bg-secondary mt-1">Created by ${e.created_by}</small>
                </div>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteEvent(${e.id})"><i class="bi bi-trash"></i></button>
            </div>
        </div>
    `).join('');
}

document.getElementById('prevMonth').addEventListener('click', () => {
    currentMonth.setMonth(currentMonth.getMonth() - 1);
    renderCalendar();
});

document.getElementById('nextMonth').addEventListener('click', () => {
    currentMonth.setMonth(currentMonth.getMonth() + 1);
    renderCalendar();
});

document.getElementById('saveEventBtn').addEventListener('click', async () => {
    const data = {
        group_id: document.getElementById('eventGroup').value,
        title: document.getElementById('eventTitle').value,
        description: document.getElementById('eventDescription').value,
        event_date: document.getElementById('eventDate').value,
        event_time: document.getElementById('eventTime').value,
        all_day: document.getElementById('eventAllDay').checked ? 'true' : 'false'
    };
    
    if (!data.group_id || !data.title || !data.event_date) { alert('Fill required fields'); return; }
    
    await fetch('/api/calendar/events', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
    eventModal.hide();
    document.getElementById('eventForm').reset();
    loadEvents();
});

async function deleteEvent(id) {
    if (!confirm('Delete this event?')) return;
    await fetch(`/api/calendar/events/${id}`, { method: 'DELETE' });
    loadEvents();
}

eventModal = new bootstrap.Modal(document.getElementById('eventModal'));
loadEvents();
</script>
{% endblock %}
