{% extends "base.html" %}
{% block title %}Admin Dashboard - Receipt Tracker{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-info">
            <i class="bi bi-shield-check me-2"></i><strong>Admin Dashboard</strong> - Manage users and groups across the system
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12 d-flex justify-content-between align-items-center">
        <div><h2 class="mb-0">User Management</h2></div>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#userModal">
            <i class="bi bi-person-plus me-2"></i>Create User
        </button>
    </div>
</div>

<div class="row mb-4">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header"><i class="bi bi-people me-2"></i>All Users</div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th>Username</th>
                                <th>Full Name</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersList"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card mb-3">
            <div class="card-header"><i class="bi bi-graph-up me-2"></i>System Stats</div>
            <div class="card-body">
                <div class="d-flex justify-content-between mb-3">
                    <span>Total Users</span>
                    <strong id="totalUsers">0</strong>
                </div>
                <div class="d-flex justify-content-between mb-3">
                    <span>Active Users</span>
                    <strong id="activeUsers" class="text-success">0</strong>
                </div>
                <div class="d-flex justify-content-between mb-3">
                    <span>Administrators</span>
                    <strong id="adminCount" class="text-primary">0</strong>
                </div>
                <div class="d-flex justify-content-between">
                    <span>Total Groups</span>
                    <strong id="totalGroups">0</strong>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-header"><i class="bi bi-info-circle me-2"></i>Admin Info</div>
            <div class="card-body">
                <p class="small mb-2"><strong>As an admin, you can:</strong></p>
                <ul class="small">
                    <li>Create new user accounts</li>
                    <li>Reset user passwords</li>
                    <li>Activate/deactivate users</li>
                    <li>Assign admin privileges</li>
                    <li>Manage all groups</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <h3 class="mb-3">Group Management</h3>
        <div class="card">
            <div class="card-header"><i class="bi bi-people-fill me-2"></i>All Groups</div>
            <div class="card-body" id="groupsAdminList"></div>
        </div>
    </div>
</div>

<!-- User Modal -->
<div class="modal fade" id="userModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userModalTitle">Create User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <input type="hidden" id="userId">
                    <div class="mb-3">
                        <label class="form-label">Username <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="username" required>
                        <small class="text-muted">Used for login</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Full Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="fullName" required>
                        <small class="text-muted">Display name used throughout the app</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Password <span class="text-danger" id="pwdRequired">*</span></label>
                        <input type="password" class="form-control" id="password">
                        <small class="text-muted">Leave blank to keep existing password</small>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="isAdmin">
                        <label class="form-check-label" for="isAdmin">Administrator privileges</label>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="isActive" checked>
                        <label class="form-check-label" for="isActive">Account active</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveUserBtn">Save User</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let userModal;

async function loadUsers() {
    const users = await fetch('/api/admin/users').then(r => r.json());
    const tbody = document.getElementById('usersList');
    
    // Update stats
    document.getElementById('totalUsers').textContent = users.length;
    document.getElementById('activeUsers').textContent = users.filter(u => u.active === 'true').length;
    document.getElementById('adminCount').textContent = users.filter(u => u.is_admin === 'true').length;
    
    tbody.innerHTML = users.map(u => `
        <tr class="${u.active === 'false' ? 'table-secondary' : ''}">
            <td><i class="bi bi-person-circle me-2"></i>${u.username}</td>
            <td>${u.full_name}</td>
            <td>
                ${u.is_admin === 'true' ? 
                    '<span class="badge bg-danger"><i class="bi bi-shield-check"></i> Admin</span>' : 
                    '<span class="badge bg-secondary">User</span>'}
            </td>
            <td>
                ${u.active === 'true' ? 
                    '<span class="badge bg-success">Active</span>' : 
                    '<span class="badge bg-secondary">Inactive</span>'}
            </td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick='editUser(${JSON.stringify(u)})'><i class="bi bi-pencil"></i></button>
                    <button class="btn btn-outline-danger" onclick="deleteUser(${u.id})" ${u.id === '{{ current_user.id }}' ? 'disabled' : ''}>
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

async function loadGroupsAdmin() {
    const [groups, users] = await Promise.all([
        fetch('/api/groups').then(r => r.json()),
        fetch('/api/admin/users').then(r => r.json())
    ]);
    
    document.getElementById('totalGroups').textContent = groups.length;
    
    const container = document.getElementById('groupsAdminList');
    if (!groups.length) {
        container.innerHTML = '<p class="text-muted text-center py-3">No groups yet</p>';
        return;
    }
    
    container.innerHTML = groups.map(g => {
        const members = g.members.split(',');
        return `
        <div class="border rounded p-3 mb-3">
            <div class="d-flex justify-content-between mb-2">
                <h5 class="mb-0"><i class="bi bi-people-fill text-primary me-2"></i>${g.name}</h5>
                <span class="badge bg-secondary">${members.length} members</span>
            </div>
            <div class="d-flex flex-wrap gap-2">
                ${members.map(m => `<span class="badge bg-light text-dark">${m}</span>`).join('')}
            </div>
        </div>`;
    }).join('');
}

function editUser(user) {
    document.getElementById('userModalTitle').textContent = 'Edit User';
    document.getElementById('userId').value = user.id;
    document.getElementById('username').value = user.username;
    document.getElementById('fullName').value = user.full_name;
    document.getElementById('password').value = '';
    document.getElementById('isAdmin').checked = user.is_admin === 'true';
    document.getElementById('isActive').checked = user.active === 'true';
    document.getElementById('pwdRequired').style.display = 'none';
    userModal.show();
}

async function deleteUser(id) {
    if (!confirm('Deactivate this user? They will no longer be able to log in.')) return;
    await fetch(`/api/admin/users/${id}`, { method: 'DELETE' });
    loadUsers();
}

document.getElementById('saveUserBtn').addEventListener('click', async () => {
    const id = document.getElementById('userId').value;
    const data = {
        username: document.getElementById('username').value,
        full_name: document.getElementById('fullName').value,
        password: document.getElementById('password').value,
        is_admin: document.getElementById('isAdmin').checked,
        active: document.getElementById('isActive').checked
    };
    
    if (!data.username || !data.full_name) { alert('Fill required fields'); return; }
    if (!id && !data.password) { alert('Password required for new users'); return; }
    
    try {
        if (id) {
            await fetch(`/api/admin/users/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
        } else {
            const res = await fetch('/api/admin/users', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
            const result = await res.json();
            if (!result.success) { alert(result.error); return; }
        }
        userModal.hide();
        resetUserForm();
        loadUsers();
    } catch (e) { alert('Error: ' + e.message); }
});

function resetUserForm() {
    document.getElementById('userForm').reset();
    document.getElementById('userId').value = '';
    document.getElementById('userModalTitle').textContent = 'Create User';
    document.getElementById('pwdRequired').style.display = 'inline';
}

document.getElementById('userModal').addEventListener('hidden.bs.modal', resetUserForm);

userModal = new bootstrap.Modal(document.getElementById('userModal'));
loadUsers();
loadGroupsAdmin();
</script>
{% endblock %}
